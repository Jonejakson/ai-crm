# Исправление ошибки 502 Bad Gateway

## Проблема
Nginx возвращает 502 ошибку, что означает, что он не может подключиться к приложению на порту 3000.

## Возможные причины:
1. Контейнер приложения не запущен или падает
2. Приложение не слушает на правильном порту
3. Проблемы с переменными окружения
4. Ошибки в коде приложения

## Решение

### На сервере выполните:

```bash
ssh root@79.143.30.96
cd /opt/flamecrm

# 1. Проверьте статус
docker-compose ps -a

# 2. Посмотрите логи
docker-compose logs --tail=50 app

# 3. Остановите и удалите контейнер
docker-compose stop app
docker-compose rm -f app

# 4. Пересоберите и запустите
docker-compose build --no-cache app
docker-compose up -d app

# 5. Подождите 30 секунд
sleep 30

# 6. Проверьте статус
docker-compose ps

# 7. Проверьте доступность
curl http://127.0.0.1:3000/api/health

# 8. Если не работает, проверьте логи
docker-compose logs app

# 9. Перезагрузите Nginx
systemctl reload nginx
```

### Если контейнер падает сразу после запуска:

1. Проверьте переменные окружения в `.env` файле
2. Убедитесь, что все обязательные переменные установлены:
   - `POSTGRES_PASSWORD`
   - `NEXTAUTH_SECRET` или `AUTH_SECRET`
   - `ENCRYPTION_KEY`
   - `DATABASE_URL` (генерируется автоматически из POSTGRES_PASSWORD)

3. Проверьте логи на ошибки:
```bash
docker-compose logs app | grep -i error
```

### Если проблема в Nginx:

Проверьте конфигурацию:
```bash
cat /etc/nginx/sites-available/crm
nginx -t
```

Убедитесь, что `proxy_pass` указывает на `http://127.0.0.1:3000;`





