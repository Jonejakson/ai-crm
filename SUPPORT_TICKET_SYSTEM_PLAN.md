# План реализации системы тикетов поддержки

## Текущее состояние

✅ Есть модель `SupportTicket` в базе данных
✅ Есть API для создания тикетов (`POST /api/support`)
✅ Есть форма отправки тикета на странице `/support`
✅ Есть email интеграции (IMAP, Gmail, Outlook, Yandex)
✅ Есть функционал получения писем через IMAP

## Варианты реализации

### Вариант 1: Гибридная система (РЕКОМЕНДУЕТСЯ) ⭐

**Как работает:**
1. Пользователь создает тикет в системе → сохраняется в БД
2. Система отправляет email админу с уникальным ID тикета в теме/теле письма
3. Админ отвечает с почты (Reply) → система парсит ответ и добавляет в тикет
4. Пользователь видит переписку в системе

**Плюсы:**
- ✅ Можно отвечать с почты (удобно для одного админа)
- ✅ Можно отвечать из системы (удобно для команды в будущем)
- ✅ История переписки хранится в системе
- ✅ Пользователь видит все ответы в одном месте
- ✅ Можно добавить автоматические уведомления

**Минусы:**
- ⚠️ Нужен IMAP для получения ответов
- ⚠️ Нужен парсинг email thread (In-Reply-To, References)
- ⚠️ Нужно правильно форматировать email при отправке

**Технические детали:**
- Использовать существующую EmailIntegration для получения писем
- Добавить поле `ticketId` в заголовок email (X-Ticket-ID или в теме)
- Парсить ответы по `In-Reply-To` или `References` headers
- Создать модель `SupportTicketMessage` для хранения переписки

---

### Вариант 2: Полностью внутренняя система

**Как работает:**
1. Пользователь создает тикет → сохраняется в БД
2. Админ видит тикет в админ-панели
3. Админ отвечает через веб-интерфейс
4. Система отправляет email пользователю с ответом
5. Пользователь видит переписку в системе

**Плюсы:**
- ✅ Проще реализовать (не нужен IMAP парсинг)
- ✅ Полный контроль над форматированием
- ✅ Можно добавить rich text редактор
- ✅ Легко добавить вложения

**Минусы:**
- ❌ Нужно заходить в систему для ответа
- ❌ Неудобно для одного админа (нужно постоянно проверять систему)
- ❌ Нет возможности отвечать с мобильного через почту

---

### Вариант 3: Email-based система

**Как работает:**
1. Пользователь создает тикет → отправляется email админу
2. Админ отвечает с почты
3. Система парсит ответ и создает тикет/обновляет существующий
4. Пользователь получает ответ на email

**Плюсы:**
- ✅ Максимально просто для админа
- ✅ Не нужен веб-интерфейс для ответов

**Минусы:**
- ❌ Пользователь не видит историю в системе
- ❌ Сложнее отслеживать статусы тикетов
- ❌ Нужен сложный парсинг email для создания тикетов из писем

---

## Рекомендация: Вариант 1 (Гибридная система)

**Почему:**
1. **Для одного админа** - можно отвечать с почты, не заходя в систему
2. **Для пользователей** - видят всю переписку в системе
3. **Масштабируемость** - в будущем можно добавить команду поддержки
4. **Гибкость** - можно отвечать и из системы, и с почты

## Что нужно реализовать

### 1. Расширить модель SupportTicket

```prisma
model SupportTicket {
  id        Int      @id @default(autoincrement())
  subject   String
  message   String
  email     String
  status    String   @default("open") // open, in_progress, resolved, closed
  company   Company  @relation(fields: [companyId], references: [id])
  companyId Int
  user      User?    @relation(fields: [userId], references: [id])
  userId    Int?
  messages  SupportTicketMessage[] // НОВОЕ: переписка
  ticketId  String   @unique // НОВОЕ: уникальный ID для email (например: TKT-12345)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model SupportTicketMessage {
  id        Int           @id @default(autoincrement())
  ticket    SupportTicket @relation(fields: [ticketId], references: [id])
  ticketId  Int
  message   String
  fromEmail String // Кто отправил
  fromName  String? // Имя отправителя
  isFromAdmin Boolean @default(false) // Ответ от админа или от пользователя
  emailMessageId String? // Message-ID из email для парсинга thread
  createdAt DateTime @default(now())
}
```

### 2. Обновить API создания тикета

- Генерировать уникальный `ticketId` (например: `TKT-{timestamp}-{random}`)
- Отправлять email админу с темой: `[TKT-12345] {subject}`
- В теле письма указывать `Reply-To: support@yourdomain.com` с ticketId

### 3. Создать API для получения тикетов пользователя

```typescript
GET /api/support/tickets
// Возвращает список тикетов пользователя с перепиской
```

### 4. Создать email handler для парсинга ответов

- Использовать существующий IMAP клиент
- Парсить письма с темой `Re: [TKT-...]`
- Извлекать ticketId из темы или заголовков
- Создавать `SupportTicketMessage` с ответом

### 5. Обновить UI страницы поддержки

- Добавить блок "Мои тикеты" со списком
- Показывать переписку по каждому тикету
- Показывать статус (открыт, в работе, решен)
- Позволить пользователю отвечать на тикет

### 6. Создать админ-панель для тикетов (опционально)

- Список всех тикетов
- Фильтры по статусу
- Возможность отвечать из системы
- Изменение статуса

## Пример формата email

**Отправка тикета админу:**
```
To: admin@yourdomain.com
Subject: [TKT-12345] Не приходят письма
Reply-To: support+12345@yourdomain.com (или в заголовке X-Ticket-ID: 12345)

Новый тикет поддержки #12345

От: sale1@barier-yug.ru
Тема: Не приходят письма

Сообщение:
Опишите проблему...
```

**Ответ админа (Reply):**
```
To: support+12345@yourdomain.com (или парсим X-Ticket-ID)
Subject: Re: [TKT-12345] Не приходят письма
In-Reply-To: <original-message-id>

Ваш ответ...
```

## План реализации (по приоритету)

1. **Этап 1: Базовая функциональность**
   - Расширить модель БД (SupportTicketMessage)
   - Обновить API создания тикета (генерация ticketId, отправка email)
   - Добавить API получения тикетов пользователя
   - Обновить UI (список тикетов, переписка)

2. **Этап 2: Email интеграция**
   - Создать email handler для парсинга ответов
   - Настроить IMAP для получения писем
   - Парсить ответы и добавлять в тикеты

3. **Этап 3: Улучшения**
   - Статусы тикетов
   - Уведомления
   - Админ-панель (если нужно)

## Вопросы для уточнения

1. Какой email использовать для поддержки? (support@yourdomain.com?)
2. Нужна ли админ-панель для тикетов или достаточно отвечать с почты?
3. Нужны ли уведомления пользователю при ответе админа?
4. Нужны ли статусы тикетов (открыт, в работе, решен)?


