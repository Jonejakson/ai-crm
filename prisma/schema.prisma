generator client {
    provider = "prisma-client-js"
}

datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL")
}

enum PlanSlug {
    LITE
    TEAM
    PRO
}

enum SubscriptionStatus {
    TRIAL
    ACTIVE
    PAST_DUE
    CANCELED
}

enum BillingInterval {
    MONTHLY
    YEARLY
}

enum InvoiceStatus {
    PENDING
    PAID
    FAILED
}

enum AutomationTriggerType {
    DEAL_STAGE_CHANGED
    DEAL_CREATED
    DEAL_AMOUNT_CHANGED
    TASK_CREATED
    TASK_COMPLETED
    CONTACT_CREATED
    EVENT_CREATED
}

enum AutomationActionType {
    CREATE_TASK
    SEND_EMAIL
    CHANGE_PROBABILITY
    ASSIGN_USER
    CREATE_NOTIFICATION
    UPDATE_DEAL_STAGE
}

model Company {
    id        Int       @id @default(autoincrement())
    name      String
    createdAt DateTime  @default(now())
    updatedAt DateTime  @updatedAt
    users     User[]
    pipelines Pipeline[]
    trialEndsAt DateTime?
    subscriptions Subscription[]
    automations Automation[]
    activityLogs ActivityLog[]
}

model User {
    id            Int            @id @default(autoincrement())
    email         String         @unique
    name          String
    password      String
    role          String         @default("user") // user, manager, admin
    company       Company        @relation(fields: [companyId], references: [id])
    companyId     Int
    createdAt     DateTime       @default(now())
    updatedAt     DateTime       @updatedAt
    tasks         Task[]
    contacts      Contact[]
    deals         Deal[]
    events        Event[]
    notifications Notification[]
    emailMessages EmailMessage[]
    activityLogs  ActivityLog[]
    files         File[]
    comments      Comment[]
}

model Contact {
    id        Int      @id @default(autoincrement())
    name      String
    email     String?
    phone     String?
    company   String?
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt
    user      User?    @relation(fields: [userId], references: [id])
    userId    Int?
    tasks     Task[]
    dialogs   Dialog[]
    deals     Deal[]
    events    Event[]
    emailMessages EmailMessage[]
}

model Task {
    id          Int      @id @default(autoincrement())
    title       String
    description String?
    status      String   @default("pending")
    dueDate     DateTime?
    createdAt   DateTime @default(now())
    updatedAt   DateTime @updatedAt
    contact     Contact? @relation(fields: [contactId], references: [id])
    contactId   Int?
    user        User?    @relation(fields: [userId], references: [id])
    userId      Int?
}

model Dialog {
    id        Int      @id @default(autoincrement())
    message   String
    sender    String   @default("user")
    createdAt DateTime @default(now())
    contact   Contact? @relation(fields: [contactId], references: [id])
    contactId Int?
}

model Pipeline {
    id        Int      @id @default(autoincrement())
    name      String
    stages    String   // JSON массив этапов с цветами
    isDefault Boolean  @default(false)
    company   Company  @relation(fields: [companyId], references: [id])
    companyId Int
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt
    deals     Deal[]
}

model Deal {
    id              Int       @id @default(autoincrement())
    title           String
    amount          Float     @default(0)
    currency        String    @default("RUB")
    stage           String    // этап воронки
    probability     Int       @default(0) // 0-100%
    expectedCloseDate DateTime?
    contact         Contact   @relation(fields: [contactId], references: [id])
    contactId       Int
    user            User      @relation(fields: [userId], references: [id])
    userId          Int
    pipeline        Pipeline? @relation(fields: [pipelineId], references: [id])
    pipelineId      Int?
    createdAt       DateTime  @default(now())
    updatedAt       DateTime  @updatedAt
}

model Event {
    id          Int       @id @default(autoincrement())
    title       String
    description String?
    startDate   DateTime
    endDate     DateTime?
    location    String?
    type        String    @default("meeting") // meeting, call, task, other
    contact     Contact?  @relation(fields: [contactId], references: [id])
    contactId   Int?
    user        User      @relation(fields: [userId], references: [id])
    userId      Int
    createdAt   DateTime  @default(now())
    updatedAt   DateTime  @updatedAt
}

model Notification {
    id        Int       @id @default(autoincrement())
    title     String
    message   String
    type      String    @default("info") // info, warning, success, error
    entityType String?  // task, deal, event, contact
    entityId   Int?
    isRead    Boolean   @default(false)
    user      User      @relation(fields: [userId], references: [id])
    userId    Int
    createdAt DateTime  @default(now())
}

model EmailMessage {
    id         Int      @id @default(autoincrement())
    subject    String
    body       String
    status     String   @default("pending")
    error      String?
    providerId String?
    toEmail    String
    createdAt  DateTime @default(now())
    user       User?    @relation(fields: [userId], references: [id])
    userId     Int?
    contact    Contact? @relation(fields: [contactId], references: [id])
    contactId  Int?
}

model Plan {
    id            Int         @id @default(autoincrement())
    name          String
    slug          PlanSlug    @unique
    description   String?
    price         Int         @default(0) // цена в минорных единицах (например, копейки)
    currency      String      @default("RUB")
    userLimit     Int?
    contactLimit  Int?
    pipelineLimit Int?
    features      Json?
    createdAt     DateTime    @default(now())
    updatedAt     DateTime    @updatedAt
    subscriptions Subscription[]
}

model Subscription {
    id                Int                @id @default(autoincrement())
    company           Company            @relation(fields: [companyId], references: [id])
    companyId         Int
    plan              Plan               @relation(fields: [planId], references: [id])
    planId            Int
    status            SubscriptionStatus @default(TRIAL)
    billingInterval   BillingInterval    @default(MONTHLY)
    currentPeriodEnd  DateTime?
    trialEndsAt       DateTime?
    cancelAtPeriodEnd Boolean            @default(false)
    externalCustomerId    String?
    externalSubscriptionId String?
    createdAt         DateTime           @default(now())
    updatedAt         DateTime           @updatedAt
    invoices          Invoice[]
}

model Invoice {
    id             Int            @id @default(autoincrement())
    subscription   Subscription   @relation(fields: [subscriptionId], references: [id])
    subscriptionId Int
    amount         Int
    currency       String         @default("RUB")
    status         InvoiceStatus  @default(PENDING)
    paidAt         DateTime?
    externalId     String?
    createdAt      DateTime       @default(now())
}

model Automation {
    id          Int                  @id @default(autoincrement())
    name        String
    description String?
    isActive    Boolean              @default(true)
    triggerType AutomationTriggerType
    triggerConfig Json?              // условия триггера (например, stage name, amount threshold)
    actions     Json                 // массив действий
    company     Company              @relation(fields: [companyId], references: [id])
    companyId   Int
    createdAt   DateTime             @default(now())
    updatedAt   DateTime             @updatedAt
}

model ActivityLog {
    id          Int      @id @default(autoincrement())
    entityType  String   // deal, contact, task, event
    entityId    Int
    action      String   // created, updated, deleted, stage_changed, etc.
    description String?
    metadata    Json?    // дополнительные данные
    user        User?    @relation(fields: [userId], references: [id])
    userId      Int?
    company     Company  @relation(fields: [companyId], references: [id])
    companyId   Int
    createdAt   DateTime @default(now())
}

model File {
    id          Int      @id @default(autoincrement())
    name        String
    originalName String
    url         String
    size        Int      // размер в байтах
    mimeType    String
    entityType  String   // contact, deal, task, event
    entityId    Int
    user        User?    @relation(fields: [userId], references: [id])
    userId      Int?
    createdAt   DateTime @default(now())
}

model Comment {
    id          Int      @id @default(autoincrement())
    text        String
    entityType  String   // deal, task
    entityId    Int
    user        User     @relation(fields: [userId], references: [id])
    userId      Int
    createdAt   DateTime @default(now())
    updatedAt   DateTime @updatedAt
}