#!/bin/bash
# –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –¥–µ–ø–ª–æ–π –±–µ–∑ —É–¥–∞–ª–µ–Ω–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: ./scripts/safe-deploy.sh

# –ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ–º set -e, —á—Ç–æ–±—ã –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –æ—à–∏–±–∫–∏ –≤—Ä—É—á–Ω—É—é

echo "üöÄ –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –¥–µ–ø–ª–æ–π CRM"
echo "================================"
echo ""

# –¶–≤–µ—Ç–∞
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫
handle_error() {
    echo -e "${RED}‚ùå –û—à–∏–±–∫–∞: $1${NC}"
    exit 1
}

# –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ –º—ã –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
if [ ! -f "docker-compose.yml" ]; then
    handle_error "docker-compose.yml –Ω–µ –Ω–∞–π–¥–µ–Ω"
fi

echo "1Ô∏è‚É£  –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ (–ë–î —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è)..."
docker-compose down 2>/dev/null || true
echo -e "${GREEN}‚úÖ –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã${NC}"
echo ""

echo "2Ô∏è‚É£  –ü–µ—Ä–µ—Å–±–æ—Ä–∫–∞ Docker-–æ–±—Ä–∞–∑–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
if ! docker-compose build --no-cache app; then
    handle_error "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–±—Ä–∞—Ç—å –æ–±—Ä–∞–∑"
fi
echo -e "${GREEN}‚úÖ –°–±–æ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞${NC}"
echo ""

echo "3Ô∏è‚É£  –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ (–µ—Å–ª–∏ –µ—Å—Ç—å)..."
docker-compose rm -f app 2>/dev/null || true
echo ""

echo "4Ô∏è‚É£  –ó–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤..."
# –ò—Å–ø–æ–ª—å–∑—É–µ–º --force-recreate —á—Ç–æ–±—ã –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
if ! docker-compose up -d --force-recreate; then
    echo -e "${YELLOW}‚ö†Ô∏è  –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ, –ø—Ä–æ–±—É–µ–º –ø–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å –æ–±—Ä–∞–∑...${NC}"
    # –ï—Å–ª–∏ –æ–±—Ä–∞–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø–µ—Ä–µ—Å–æ–±–∏—Ä–∞–µ–º
    docker-compose build app
    docker-compose up -d --force-recreate
fi
echo -e "${GREEN}‚úÖ –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –∑–∞–ø—É—â–µ–Ω—ã${NC}"
echo ""

echo "5Ô∏è‚É£  –û–∂–∏–¥–∞–Ω–∏–µ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ PostgreSQL (15 —Å–µ–∫—É–Ω–¥)..."
sleep 15

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ PostgreSQL
for i in {1..10}; do
    if docker-compose exec -T postgres pg_isready -U crm_user > /dev/null 2>&1; then
        echo -e "${GREEN}‚úÖ PostgreSQL –≥–æ—Ç–æ–≤${NC}"
        break
    fi
    echo "   –û–∂–∏–¥–∞–Ω–∏–µ... ($i/10)"
    sleep 3
done
echo ""

echo "6Ô∏è‚É£  –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö (–µ—Å–ª–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ)..."
PRISMA_VERSION="6.19.0"
echo "   –ò—Å–ø–æ–ª—å–∑—É–µ–º Prisma CLI v${PRISMA_VERSION}"
if ! docker-compose exec -T app npx "prisma@${PRISMA_VERSION}" migrate deploy; then
    handle_error "–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö"
fi
echo -e "${GREEN}‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∏–≥—Ä–∞—Ü–∏–π –∑–∞–≤–µ—Ä—à–µ–Ω–∞${NC}"
echo ""

echo "7Ô∏è‚É£  –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞..."
docker-compose ps
echo ""

echo -e "${GREEN}‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ!${NC}"
echo ""
echo "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: docker-compose logs -f app"


