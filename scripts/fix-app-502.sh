#!/bin/bash

# –ü–æ–ª–Ω–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã 502 –¥–ª—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

set -e

echo "üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã 502 Bad Gateway"
echo ""

cd /opt/flamecrm || exit 1

echo "1Ô∏è‚É£ –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ —É–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä–æ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞..."
docker-compose stop app || true
docker-compose rm -f app || true

echo ""
echo "2Ô∏è‚É£ –ü–µ—Ä–µ—Å–±–æ—Ä–∫–∞ –æ–±—Ä–∞–∑–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
docker-compose build --no-cache app

echo ""
echo "3Ô∏è‚É£ –ó–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞..."
docker-compose up -d app

echo ""
echo "4Ô∏è‚É£ –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞ (30 —Å–µ–∫—É–Ω–¥)..."
sleep 30

echo ""
echo "5Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞:"
docker-compose ps

echo ""
echo "6Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:"
if curl -s http://127.0.0.1:3000/api/health > /dev/null; then
    echo "‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç!"
    curl -s http://127.0.0.1:3000/api/health | head -1
else
    echo "‚ùå –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç"
    echo ""
    echo "üìã –ü–æ—Å–ª–µ–¥–Ω–∏–µ –ª–æ–≥–∏:"
    docker-compose logs --tail=30 app
fi

echo ""
echo "7Ô∏è‚É£ –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ Nginx..."
systemctl reload nginx

echo ""
echo "8Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ Nginx:"
HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" https://flamecrm.ru/api/health)
if [ "$HTTP_CODE" = "200" ]; then
    echo "‚úÖ –°–∞–π—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç! HTTP –∫–æ–¥: $HTTP_CODE"
else
    echo "‚ö†Ô∏è  HTTP –∫–æ–¥: $HTTP_CODE"
    echo "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ Nginx: tail -20 /var/log/nginx/error.log"
fi

echo ""
echo "‚úÖ –ì–æ—Ç–æ–≤–æ!"


