# Система компаний и ролей

## Что реализовано

### 1. Модель Company
- Добавлена модель `Company` в базу данных
- Каждый пользователь привязан к компании (`companyId`)
- Воронки продаж (Pipeline) также привязаны к компании

### 2. Роли пользователей
- **admin** - видит все данные своей компании, может создавать пользователей
- **manager** - видит только свои данные (контакты, задачи, сделки, события)
- **user** - видит только свои данные

### 3. Фильтрация данных
- Админ видит все данные всех пользователей своей компании
- Менеджер/пользователь видит только свои данные
- Фильтрация реализована через утилиту `lib/access-control.ts`

### 4. API Endpoints

#### Для админа:
- `GET /api/admin/users` - список всех пользователей компании
- `GET /api/admin/company-stats` - статистика всей компании
- `POST /api/admin/users/create` - создать пользователя в компании

#### Обновленные endpoints:
- `GET /api/contacts` - теперь учитывает роль (админ видит всю компанию, менеджер - только свои)

## Как использовать

### 1. Создать компанию и админа

При регистрации первого пользователя автоматически создается компания. Чтобы сделать пользователя админом:

```sql
UPDATE "User" SET role = 'admin' WHERE email = 'ваш_email@example.com';
```

Или через Prisma Studio:
1. Запустите `npm run db:studio`
2. Найдите пользователя
3. Измените `role` на `admin`

### 2. Добавить менеджеров в компанию

Админ может создавать пользователей через API:

```bash
POST /api/admin/users/create
{
  "email": "manager@example.com",
  "password": "password123",
  "name": "Manager Name",
  "role": "manager"
}
```

### 3. Просмотр статистики компании

Админ может получить статистику всей компании:

```bash
GET /api/admin/company-stats
```

Возвращает:
- Статистику по пользователям
- Статистику по контактам (по каждому пользователю)
- Статистику по задачам (по каждому пользователю)
- Статистику по сделкам (по каждому пользователю)
- Статистику по событиям (по каждому пользователю)

## Что еще нужно сделать

### Обновить остальные API endpoints:
- [ ] `app/api/tasks/route.ts` - добавить фильтрацию по ролям
- [ ] `app/api/deals/route.ts` - добавить фильтрацию по ролям
- [ ] `app/api/events/route.ts` - добавить фильтрацию по ролям
- [ ] `app/api/analytics/route.ts` - обновить для админа (показывать всю компанию)

### Создать UI:
- [ ] Страница админ-панели со статистикой компании
- [ ] Страница управления пользователями (для админа)
- [ ] Форма создания пользователей (для админа)

## Миграция

Миграция уже применена к базе данных. Все существующие пользователи привязаны к дефолтной компании "Default Company".

Чтобы изменить название компании:

```sql
UPDATE "Company" SET name = 'Ваша Компания' WHERE id = 1;
```

Или через Prisma Studio.

