# Исправление кодировки (кракозябры после слияния БД)

## Что сделано

1. **Подключение к БД — принудительно UTF-8**  
   В `lib/init-prisma.ts` к `DATABASE_URL` добавляется `client_encoding=UTF8`, если его ещё нет. Все новые подключения к PostgreSQL работают в UTF-8.

2. **Тексты тарифов — из кода, не из БД**  
   Файл `lib/plan-display-text.ts`: названия и описания планов (Lite, Team, Pro) заданы в коде в UTF-8.  
   На страницах **Компания** и **Кабинет владельца** (owner) для отображения используются эти тексты по `planSlug` (LITE, TEAM, PRO), а не значения из БД. Так кракозябры в таблице Plan не влияют на интерфейс.

3. **API-ответы**  
   Для ответов с кириллицей используется хелпер `lib/json-response.ts` с заголовком `Content-Type: application/json; charset=utf-8`.

## Если кракозябры остались (названия компаний, имена пользователей и т.п.)

Это **пользовательские данные**, уже записанные в БД (в т.ч. после слияния/импорта в другой кодировке). Их нельзя «взять из кода» — только из базы.

Варианты:

1. **Восстановить БД из бэкапа** до слияния (если есть дамп с нормальной кодировкой).
2. **Скрипт перекодировки** по нужным таблицам/полям: прочитать значение, интерпретировать байты в исходной кодировке (например Windows-1251), перекодировать в UTF-8, записать обратно. Делать только по копии БД и с проверкой на тестовых данных.
3. **Проверить кодировку БД на сервере**:
   ```sql
   SELECT datname, pg_encoding_to_char(encoding) FROM pg_database WHERE datname = current_database();
   ```
   Должно быть `UTF8`. Если нет — базу создавали в другой кодировке; новые записи через приложение с `client_encoding=UTF8` будут в UTF-8, старые могут остаться в старой кодировке.

## Где уже не зависит от БД

- Названия и описания планов (Lite, Team, Pro) — везде берутся из `lib/plan-display-text.ts` по `planSlug`.
