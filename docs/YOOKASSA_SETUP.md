# Настройка YooKassa для приема платежей

## 1. Регистрация в YooKassa

1. Зайдите на https://yookassa.ru
2. Зарегистрируйте аккаунт (если еще нет)
3. Пройдите верификацию (для приема реальных платежей)

## 2. Получение ключей API

1. Войдите в личный кабинет YooKassa
2. Перейдите в раздел "Настройки" → "API"
3. Скопируйте:
   - **Shop ID** (идентификатор магазина)
   - **Secret Key** (секретный ключ)

## 3. Настройка переменных окружения

Добавьте в `.env` файл (локально) и в настройки Vercel (для продакшена):

```env
YOOKASSA_SHOP_ID=your_shop_id_here
YOOKASSA_SECRET_KEY=your_secret_key_here
```

## 4. Настройка Webhook

1. В личном кабинете YooKassa перейдите в "Настройки" → "Уведомления"
2. Добавьте URL для webhook:
   ```
   https://your-domain.com/api/billing/webhook
   ```
   Для Vercel это будет:
   ```
   https://ai-crm-flame.vercel.app/api/billing/webhook
   ```
3. Выберите события для отправки:
   - `payment.succeeded` (обязательно)
   - `payment.canceled` (рекомендуется)

## 5. Тестирование

### Тестовый режим

YooKassa предоставляет тестовые карты для проверки:

**Успешная оплата:**
- Номер карты: `5555 5555 5555 4444`
- Срок действия: любая будущая дата
- CVV: любые 3 цифры
- CVC: любые 3 цифры

**Отклоненная оплата:**
- Номер карты: `5555 5555 5555 4477`

### Проверка работы

1. Выберите платный тариф в разделе "Управление компанией"
2. Будет создан платеж и перенаправление на страницу оплаты YooKassa
3. Используйте тестовую карту для оплаты
4. После успешной оплаты вы будете перенаправлены на `/billing/success`
5. Webhook автоматически активирует подписку

## 6. Безопасность

⚠️ **ВАЖНО:** В production обязательно реализуйте проверку подписи webhook!

Сейчас проверка подписи отключена для упрощения. В файле `lib/payment.ts` есть функция `verifyYooKassaWebhook`, которую нужно доработать для проверки HMAC-SHA256 подписи.

## 7. Переход в продакшен

1. Завершите верификацию в YooKassa
2. Переключите магазин из тестового режима в боевой
3. Обновите ключи API в переменных окружения
4. Включите проверку подписи webhook

## Структура платежей

- **Создание платежа:** `POST /api/billing/payment`
- **Webhook:** `POST /api/billing/webhook`
- **Проверка счета:** `GET /api/billing/invoice/[id]`
- **Страница успеха:** `/billing/success`
- **Страница отмены:** `/billing/cancel`

## Поддержка

При возникновении проблем:
1. Проверьте логи в Vercel
2. Проверьте настройки webhook в YooKassa
3. Убедитесь, что переменные окружения установлены правильно

