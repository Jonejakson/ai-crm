#!/bin/bash
set -e

cd /opt/ai-crm

echo "========================================"
echo "ШАГ 1: Обновление кода из Git"
echo "========================================"
git pull origin main

echo ""
echo "========================================"
echo "ШАГ 2: Остановка текущих контейнеров"
echo "========================================"
docker-compose down

echo ""
echo "========================================"
echo "ШАГ 3: Сборка и запуск контейнеров"
echo "========================================"
echo "Это может занять 5-10 минут..."
docker-compose up -d --build

echo ""
echo "========================================"
echo "ШАГ 4: Ожидание готовности контейнеров (30 секунд)"
echo "========================================"
sleep 30
docker-compose ps

echo ""
echo "========================================"
echo "ШАГ 5: Применение миграций базы данных"
echo "========================================"
docker-compose exec -T app npx prisma migrate deploy

echo ""
echo "========================================"
echo "ШАГ 6: Генерация Prisma Client"
echo "========================================"
docker-compose exec -T app npx prisma generate

echo ""
echo "========================================"
echo "ШАГ 7: Перезапуск приложения"
echo "========================================"
docker-compose restart app
sleep 5

echo ""
echo "========================================"
echo "ШАГ 8: Финальная проверка статуса"
echo "========================================"
docker-compose ps

echo ""
echo "Последние логи приложения:"
docker-compose logs --tail=15 app

echo ""
echo "========================================"
echo "ДЕПЛОЙ ЗАВЕРШЕН УСПЕШНО!"
echo "========================================"


